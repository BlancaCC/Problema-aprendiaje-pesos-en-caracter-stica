%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  Enfriamiento simulado
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Enfriamiento simulado}

El Enfriamiento es un algoritmo de búsqueda por entornos con un criterio probabilístico de aceptación de soluciones basado en Termodinámica. 

Pretende evitar inconvenientes de la búsqueda local 
como el que finalice en óptimos locales
alejados de la solución óptima global. Para ello se 
va a permitir explorar soluciones subóptimas de una manera
controlada y cada vez más estricta. 

\subsection{Descripción del algoritmo} 

\subsubsection{Esquema de enfriamiento} 
La función que determina la probabilidad de tomar una solución peor 

\begin{equation*}
    T_{k+1} = \frac{T_k}{1 + \beta \cdot T_k}
\end{equation*}
con $\beta$ definida como 
\begin{equation*}
    \beta = \frac{T_0 - T_f}{M \cdot T_0 \cdot T_f}. 
\end{equation*}

El valor inicial de la temperatura vendrá dado por 
\begin{equation*}
    T_0 = \frac{\mu \cdot C(S_0)}{- \log (\phi)}
\end{equation*}
con $C(S_0)$ el coste de la solución inicial,
$\mu  \in [0,1]$ es la probabilidad de aceptar una solución un $\phi$ peor que la inicial. 
En esta práctica se ha fijado 
\begin{equation*}
    \mu = \phi = 0.3 \text{  y } T_f = 10^{-3}.
\end{equation*}
$T_f$ se comprobará previamente que que sea menor que la inicial. 

El resto de parámetros que configuran el algoritmo vienen
dados como: 
\begin{itemize}
    \item \textit{máximo de vecinos}$= 10 n$ con $n$ el tamaño de cada problema. 
    \item \textit{máximo de éxitos}$= 0.1$\textit{máximo de vecinos}.
    \item \textit{máximo de evaluaciones}$=1500$.
    \item \textit{iteraciones enfriamiento}$\frac{15000}{\textit{máximo vecinos}}$ 
\end{itemize}
\textcolor{red}{Cambiar esto según convenga}.
\textbf{Nota: }Se ha seleccionado \textit{máximo de vecinos}$= 10 n$ porque con \textit{máximo de vecinos}$= 10 n$ genera demasiados vecinos por lo general. 

La función \texttt{Heurística Enfriamiento} 
que es una función booleana que determina si una solución mejor que la actual merece ser considerada. 

\begin{algorithm}[H]
  \begin{algorithmic}
    \Procedure{Heuristica Enfriamiento}{ $F_w$, $F_{w_{\textit{antiguo}}}$   t}
      \State $u \gets$ \textit{valor aleatorio con distribución uniforme en }$[0,1]$ 
      \State \textbf{return } 
      $u \leq exp( -\frac{\textit{ diferencia coste }}{K T})$
    \EndProcedure
  \end{algorithmic}  
\end{algorithm} 


\textbf{Argumentos del algoritmo de enfriamiento simulado}
\begin{itemize}
  \item \textit{tamaño problema}.
  \item \textit{evaluaciones máximas}.
  \item \textit{máximo éxitos}.
  \item \textit{máximo vecinos}. 
  \item \textit{F}: función de \textit{fitness}.
  \item $T_f$
\end{itemize}


\begin{algorithm}[H]
    \caption{Enfriamiento simulado}
        \hspace*{\algorithmicindent} 
        \textbf{Salida}:
        Vector de pesos $w$.        
    \begin{algorithmic}[1]
      \Procedure{Enfriamiento Simulado}{
      Argumentos ya comentados}
            
          \State $w \gets$ vector aleatorio   
          \State \textit{mejor vector} $\gets w$ 
          \State \textit{evaluaciones} $\gets 0$ \Comment{Indica número de generaciones}
          \State  \textit{vecinos aceptados} $\gets 1$
          \State  
          \begin{equation*}
              T 
              \gets
              \frac{ \mu F(w)}{ - \log(\phi)}
          \end{equation*}
          \State \begin{equation*}
            M \gets \frac{ \textit{máximo evaluaciones }}{\textit{máximo vecinos}}
          \end{equation*}
        \State \textit{primera iteración} $\gets True$ 
        \While{ (\textit{evaluaciones} $<$ \textit{número evaluaciones máximas}
        $\wedge$
        \textit{vecinos aceptado} $> 0$
        $\wedge$
        $T < T_f$)
        $\vee$
        \textit{primera iteración}
        }
        \State \textit{vecinos aceptados}  $\gets 0$ 
        \State \textit{vecinos generados}  $\gets 0$ 
          \While{\textit{vecinos generados} < \textit{máximo vecinos}
          $\wedge$ 
          \textit{vecinos aceptados} < \textit{máximo vecinos aceptados}
          }
          \State \textit{primera iteración} $\gets False$ 
          \State $w_{vecino} \gets$ \texttt{GeneraVecino($w,\sigma$)}
          \State \textit{vecinos generados} $\gets$ \textit{vecinos generados}$+1$
          \State 
          \begin{equation*}
            \beta \gets 
            \frac{T -  T_f}{ M (T - T_f)}
          \end{equation*}

          \If{ $F(w_{vecino}) > F(w)$ o Heurística Enfriamiento($F(w)$, $F(w_{vecino})$, T)}
            \State $w \gets w_{vecino}$
            \State \textit{vecinos aceptados} $\gets$ \textit{vecinos aceptados}$+1$
            \If $F(w_{vecino}) > F(\textit{mejor vector})$
              \State \textit{mejor vector} $\gets w$. 
            \EndIf
          \EndIf
          \EndWhile
        \State
        \begin{equation*}
          T \gets
          \frac{T}{1 + \beta T}
        \end{equation*}
        \State $evaluaciones \gets evaluaciones +1$
        \EndWhile
        \State \textbf{return} \textit{mejor vector}
      \EndProcedure
    \end{algorithmic}
  \end{algorithm}